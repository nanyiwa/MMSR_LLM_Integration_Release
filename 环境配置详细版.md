# 项目环境配置指南 (Windows 系统)

本教程旨在复现 `MMSR_LLM_Integration` 项目的运行环境。

## 前置准备

1. **安装 Anaconda/Miniconda**：确保 `conda` 命令可用。
2. **更新显卡驱动**：对于 RTX 5060 等新显卡，务必去 NVIDIA 官网或 GeForce Experience 将驱动更新到最新版本（版本号建议570.xx及以上），以兼容最新的 CUDA。

------

## 1️⃣ 第一步：创建基础虚拟环境

我们将使用 **Python 3.10**，这是目前对各类深度学习库（尤其是 DeepFace 和 PyTorch）兼容性最稳健的版本。

打开 **Anaconda Prompt (PowerShell)** 或终端（记得检查下是否在项目文件夹），执行：

PowerShell

```
# 1. 创建环境
conda create -n emotion_core python=3.10 -y

# 2. 激活环境
conda activate emotion_core
```

------

## 2️⃣ 第二步：手动部署 FFmpeg (重点避坑)

**为什么不**直接用 conda install ffmpeg？

Conda 在 Windows 上安装 FFmpeg 时，常因图形依赖库（如 gdk-pixbuf）的编码问题导致安装失败或回滚。手动安装是最稳定、一劳永逸的方案。

### 操作步骤：

1. **下载**：访问 [gyan.dev (FFmpeg Builds)](https://www.google.com/search?q=https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip) （这里复制网址直接转到，不要把这个网址放进某个搜索引擎）下载 Windows 编译版压缩包。
2. **解压与放置**：
   - 解压压缩包。
   - 将解压后的文件夹改名为 `ffmpeg`。
   - 将其移动到一个固定的软件目录，例如：`D:\Software\ffmpeg`。
   - *确认：* 确保你能找到 `D:\Software\ffmpeg\bin\ffmpeg.exe` 这个文件。
3. **配置环境变量 (Path)**：
   - 按 `Win` 键 $\rightarrow$ 搜“编辑系统环境变量” $\rightarrow$ 点击“环境变量”。
   - 在下方的 **“系统变量”** 中找到 `Path`，双击编辑。
   - 新建一条，填入 `bin` 目录的绝对路径，例如：`D:\Software\ffmpeg\bin`。
   - 连续点击“确定”保存。
4. **验证**：
   - **重要：** 关闭当前**所有**已经打开的终端，重新打开一个新的终端。
   - 输入 `ffmpeg -version`。
   - *成功标志：* 输出 `ffmpeg version 7.x/8.x...` 等详细信息。

------

## 3️⃣ 第三步：安装 PyTorch (重点：显卡适配)

### （RTX 50 系显卡用户）

50系为什么要装预览版 (Nightly)？

属于最新的 Blackwell 架构 (算力 12.0 / sm_120)，目前的 PyTorch 稳定版 (Stable 2.5.x) 尚未包含对该架构的完整支持，强行运行会报错：CUDA capability sm_120 is not compatible with the current PyTorch installation。

我们需要安装 **PyTorch Nightly (开发预览版)**，配合 **CUDA 12.8**。

#### 操作步骤：

在**激活的 `(emotion_core)` 环境**下执行（刚刚关闭了终端又重新打开所以要记得conda activate emotion_core）：

Bash

```
# 安装支持 CUDA 12.8 的 PyTorch 预览版
pip install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/cu128
```

### 兼容性提示：非 RTX 50 系显卡用户看这里

如果你的显卡是 **RTX 40系 (如 4060, 4090)** 或 **RTX 30系 (如 3060, 3080)**，不需要安装预览版，可以安装更稳定的官方正式版。

**操作方法：** 将安装命令替换为以下内容（使用 **CUDA 12.1** 或 **12.4**）：

Bash

```
# 推荐：安装 Stable (稳定版) + CUDA 12.1 (兼容性最好)
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# 或者：安装 Stable (稳定版) + CUDA 12.4 (较新)
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124
```

**区别解释：**

- **`cu121` / `cu124`**：代表 CUDA 版本。
- **去掉 `--pre`**：代表不使用预览版。
- **去掉 `nightly`**：代表使用稳定版仓库。

------

## 4️⃣ 第四步：安装 Node.js
因为项目升级为现代化的前后端分离架构，必须安装 Node.js 才能运行网页前端。

下载：访问 Node.js 官网。

版本：下载 LTS (长期支持版)，例如 v20.x 或 v22.x。

安装：一路点击 Next 即可。

验证：打开一个新的终端，输入 node -v，如果显示版本号即成功。


## 5️⃣ 第五步：安装其他依赖

在项目根目录下（确保终端在 emotion_core 环境下），确保你有 `requirements.txt` 文件，（肯定有了，直接执行就行）执行安装命令：

Bash

```
pip install -r requirements.txt
```

------

## 6️⃣ 第六步：前端依赖初始化 (仅首次需要)
在项目根目录下，通过终端手动安装一次前端库（防止脚本自动安装失败）：

Bash

cd frontend
npm install
(如果看到 added xxx packages 字样，说明成功)

## 7️⃣ 最后一步（手动进入网页交互）
打开**两个**终端
一个终端（项目目录下）运行
```
 python backend/main.py
```
另一个终端（项目目录进入frontend目录，自己cd）运行
```
 npm run dev
```
然后单击终端中的网址 http://localhost:5173/  进入ui网页

（我重构了所有代码，重新配了统一的环境，以我的50系显卡参考的，应该区别不大）
